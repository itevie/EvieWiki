<!DOCTYPE html>
<html>
	<head>
		%head%
		<title>EvieWiki</title>
	</head>

	<body>
		%sidenav%
		<div class="main">
			%top%
            <div id="dim" style="display: none" class="dim"></div>
			<!--SETTING DIVS-->
			<!--CHANGE PASSWORD DIV-->
			<div id="changePasswordForm" style="display: none; z-index:8008" class="settingsForm">
                <h2>Change Password</h2>
                <label>Current Password: </label><input id="originalPassword" type="password" /><br>
                <label>New Password: </label><input id="newPassword" type="password" /><br>
                <label>Confirm New: </label><input id="confirmNewPassword" type="password" /><br><br>
                <div style="float: right">
                    <button style="display: inline" onclick="hide()">Cancel</button>
                    <button id="changePasswordFormConfBtn" style="display: inline" onclick="changePassword()">Change</button>
                </div>
            </div>
            <!--2FA DIV-->
            <div id="2faForm" style="display: none; z-index:8009" class="settingsForm">
                <h2>2FA</h2>
                <label>2FA secures your account making it much harder for anyone to get into your account, all you will need to do is input a code which will be generated by an app such as Google Authenticator</label>
                <div style="float: right">
                    <button style="display: inline" onclick="hide()">Cancel</button>
                    <button id="2faFormConfBtn" style="display: inline" onclick="get2fa()">Enable 2FA</button>
                </div>
            </div>
            <!--2FA DISPLAY DIV-->
            <div id="2faView" style="display: none; z-index: 8010" class="settingsForm">
                <h2>2FA</h2>
                <label>Here is your 2FA token, please make sure no one else at all sees this token, once you are done, click "Done" and you will have too verify it works.</label><br><br>
                <label>Click <a id="2faLink">here</a> to add the 2fa token too your authenticator</label><br><br>
                <label>Click here to view a QR code: </label><button onclick="view2faQR()">View QR</button><br><br>
                <label>Or copy & paste this token into your authenticator app: <label id="2faToken"></label></label>
                <div style="float: right">
                    <button id="2faViewConfBtn" style="display: inline" onclick="show2faVerify()">Done</button>
                </div>
            </div>
            <!--2FA VERIFY DIV-->
            <div id="2faVerify" style="display: none; z-index: 8011" class="settingsForm">
                <h2>2FA Verification</h2>
                <label>Please input a code generated by your authenticator app:</label>
                <input id="2faVerifyCode" />
                <div style="float: right">
                    <button style="display: inline" onclick="cancel2fa()">Cancel</button>
                    <button id="2faVerifyConfBtn" style="display: inline" onclick="send2faVerify()">Done</button>
                </div>
            </div>
            <!--ACCOUNT DELETION DIV-->
            <div id="accountDeleteionDiv" style="display: none; z-index: 8012" class="settingsForm">
                <h2>Account Deletion</h2>
                <p></p>

            </div>
			<h1>Settings</h1>
			<p>On this page, you can change settings about your account</p>
			<h2>Appearance</h2>
			<input type="checkbox">Enable Images</input><br>
			<input type="checkbox" id="autoHideSide" onclick="autoHideSide()">Auto hide sidenav</input>
			<h2>Security</h2>
			<button onclick="show('2faForm')">Set up 2FA</button>
			<button onclick="showBackupCodes()">Get backup codes</button>
			<button onclick="show('changePasswordForm')">Change Password</button>
			<h2>Your Content</h2>
			<button>Delete Articles</button>
			<h2>Misc.</h2>
			<button onclick="logoutAll()">Log out all devices</button>
			<h2>Account Deletion</h2>
			<button>Disable Account</button>
			<button onclick="showAccountDeletion()">Delete Account</button>
		</div>
	</body>

	<script>
        let forms = "changePasswordForm;2faForm;2faVerify;2faView;accountDeleteionDiv".split(";");

        let tfaqr = "";

        document.addEventListener("DOMContentLoaded", () => {
            if (getCookie("autoHideSide") == "true")
                document.getElementById("autoHideSide").checked = true;
        });

        function autoHideSide() {
            if (document.getElementById("autoHideSide").checked == true)
                document.cookie = "autoHideSide=true;path=/";
            else
                document.cookie = "autoHideSide=false;path=/";
        }

        function logoutAll() {
            question("Are you sure you want to log out of all sessions?", (() => logoutAllSuccess()));
        }

        function showAccountDeletion() {
            question("By deleteing your account, all your articles that you have created will be deleted, your account and all sessions will be logged out of, are you sure you want to delete your account?", (() => { showAccountDeletionPart2() }), "Account deletion");
        }

        async function showAccountDeletionPart2() {
            await setTimeout(() => {}, 1000);
            question("Are you absolutely sure you want to delete your account? If you do, you will be able to login to your account for 1 day and the account deletion will be cancelled. ", (() => { showAccountDeletionPart3() }), "Account deletion");
        }

        async function showAccountDeletionPart3() {
            await setTimeout(() => {}, 1000);
            question("After 1 day your account cannot be recovered! Continue?", (() => { showAccountDeletionPart4() }), "Account deletion");
        }

        async function showAccountDeletionPart4() {
            await setTimeout(() => {}, 1000);
            question("Are you positive?", (() => { deleteAccount() }), "Account deletion");
            document.getElementById("questionConfBtn").style.display = "none";
            setTimeout(() => {
                document.getElementById("questionConfBtn").style.display = "inline"
            }, 2000);
        }

        function deleteAccount() {
            fetch("/deleteAccount", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: "{}"
            }).then(async res => {
                if (!res.ok) {
                    let text = await res.text();
                    if (text == "Missing 2fa code") {
						return sendAfterVerify("/deleteAccount", {}, ((res) => {
                            message("Account scheduled for deletion.");
                            setTimeout(() => {
                                document.cookie = "session=;path=/";
                                location.href = "/";
                            }, 1000);
						}));
                    }
                }

                message("Account scheduled for deletion.");
                await logoutAllSuccess(true);
                setTimeout(() => {
                    document.cookie = "session=;path=/";
                    location.href = "/";
                }, 5000);
            });
        }

        async function logoutAllSuccess(silence = false) {
            fetch("/logoutAll", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: "{}"
            }).then(async res => {
                if (!res.ok) {
                    if (silence == true) return true;
                    return message(`Failed to logut all sessions: ${await res.text()}`);
                }

                if (silence == true) return true;
                message("Successfully logged out of all sessions! (" + await res.text() + ")");
                setTimeout(() => {
                    document.cookie = "session=;path=/";
                    location.reload();
                }, 1000);
            });
        }

        function showBackupCodes() {
            fetch("/getBackupCodes", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: "{}"
            }).then(async res => {
                if (!res.ok) {
                    let text = await res.text();
                    if (text == "Missing 2fa code") {
						return sendAfterVerify("/getBackupCodes", {}, ((res) => {
                            showCodes(res);
						}))
                    }
                }

                showCodes(await res.text());
            });
        }

        function showCodes(codes) {
            let html = "";
            codes = codes.slice(1, -1);
            codes = codes.replace(/"/g, "").split(",");

            for (let i in codes) {
                if (i == 2 || i == 4 || i == 6 || i == 8) html += "<br>";
                html += `<label style="font-size: 24px">${codes[i]}</label>&nbsp;&nbsp;&nbsp;`;
            }
            html = `<label>Here are your backup codes, please store them in a secure place in which you won't lose</label><br><br><center><b>${html}</b></center>`;
            message(html, "Backup Codes");
        }

        function get2fa() {
            fetch("/2fa", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: "{}"
            }).then(async res => {
                if (!res.ok) {
                    let text = await res.text();
                    if (text == "2fa is already enabled")
                        return question("2fa is already enabled, do you want to disable it?", (() => disable2fa()));
                    return message(text, "Warning");
                }

                let tokens = await res.json();
                tfaqr = tokens.qr
                document.getElementById("2faLink").href = tokens.uri;
                document.getElementById("2faToken").innerHTML = tokens.secret;
                document.getElementById("2faView").style.display = "block";
            });
        }

        function view2faQR() {
            message(`<center><img src="${tfaqr}"/ ></center>`, "2fa QR code");
        }

        function disable2fa() {
            sendAfterVerify("/disable2fa", {}, "~Successfully disabled 2fa~reload");
        }

        function hide2fa() {
            confirm("Are you sure you have saved it? If you haven't you will lose access too your account.", (() => show2faVerify()));
        }

        function show2faVerify() {
            hide();
            document.getElementById("2faVerify").style.display = "block";
            document.getElementById("dim").style.display = "block";
        }

        function send2faVerify() {
            fetch("/verify2fa", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    code: document.getElementById("2faVerifyCode").value
                })
            }).then(async res => {
                if (!res.ok) {
                    message("Oops! The code seems to be invalid, if it continues to fail, click 'Cancel' and try again", "Error");
                    return;
                }

                hide();
                autoHide = true;
                message("Your 2fa code has been activated and can now be used when logging into your account!", "Success");
            });
        }

        function changePassword() {
            let oPassword = document.getElementById("originalPassword").value;
            let password = document.getElementById("newPassword").value;
            let cPassword = document.getElementById("confirmNewPassword").value;

            let warning = "";

			if (cPassword != password) warning = "Confirmation must be equal to password";
            if (password.length < 8) warning = "Password is too short, must be 8 or more characters";

			if (warning != "") {
                message(warning);
            }
        }

        function show(id) {
            document.getElementById(id).style.display = "block";
            document.getElementById("dim").style.display = "block";
        }

        function hide() {
            for (let i in forms) {
                document.getElementById(forms[i]).style.display = "none";
            }
            document.getElementById("dim").style.display = "none";
        }
	</script>
</html>
